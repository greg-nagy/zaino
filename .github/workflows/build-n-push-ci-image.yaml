name: Docker Image CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - '**'
    paths:
      - '.env.testing-artifacts'
      - 'test_environment/*'

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to DockerHub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_ACCESS_TOKEN }}

    - name: Compute version-based image tag
      id: taggen
      run: |
        source .env.testing-artifacts
        export RUST_VERSION ZCASH_VERSION ZEBRA_VERSION
        TAG=$(./utils/get-ci-image-tag.sh)
        echo "tag=$TAG" >> "$GITHUB_OUTPUT"

    - name: Load version variables into job env
      id: versions
      run: |
        set -a
        source .env.testing-artifacts
        set +a
        echo "sha_short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"
        echo "RUST_VERSION=$RUST_VERSION" >> "$GITHUB_ENV"
        echo "ZCASH_VERSION=$ZCASH_VERSION" >> "$GITHUB_ENV"
        echo "ZEBRA_VERSION=$ZEBRA_VERSION" >> "$GITHUB_ENV"

    - name: Define build target
      id: target
      run: |
        set -a
        source ./utils/helpers.sh
        TARGET=$(resolve_build_target ${{ env.ZCASH_VERSION }} ${{ env.ZEBRA_VERSION }})
        echo "target=$TARGET" >> "$GITHUB_OUTPUT"

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v5
      with:
        context: test_environment
        file: test_environment/Dockerfile
        platforms: linux/amd64
        target: ${{ steps.target.outputs.target }}
        tags: |
          zingodevops/zaino-ci:latest
          zingodevops/zaino-ci:${{ steps.versions.outputs.sha_short }}
          zingodevops/zaino-ci:${{ steps.taggen.outputs.tag }}
        push: true
        build-args: |
          RUST_VERSION=${{ env.RUST_VERSION }}
          ZCASH_VERSION=${{ env.ZCASH_VERSION }}
          ZEBRA_VERSION=${{ env.ZEBRA_VERSION }}
