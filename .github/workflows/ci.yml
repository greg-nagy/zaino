name: CI checks

on: 
  push:
    tags:
      - '**'
  pull_request:

jobs:

  build-test-artifacts:
    name: Build test artifacts
    container:
      image: zingodevops/zaino-ci
    runs-on: ziserv-2

    if: github.event.pull_request.draft == false
    # env:
    #   RUSTFLAGS: -D warnings
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # - uses: actions-rust-lang/setup-rust-toolchain@v1

      # - name: Install nextest
      #   uses: taiki-e/install-action@v2
      #   with:
      #     tool: nextest@0.9.78

      - run: rustup toolchain install stable --profile minimal

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-provider: buildjet

      - name: Build and archive tests
        run: cargo nextest archive --verbose --workspace --all-features --archive-file nextest-archive.tar.zst

      - name: Upload archive
        uses: actions/upload-artifact@v4
        with:
          name: nextest-archive
          path: nextest-archive.tar.zst

  check:
    name: Cargo Check
    runs-on: ziserv-2
    container:
      image: zingodevops/zaino-ci:latest  # Your pre-built Docker image
    steps:
      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-provider: buildjet

      - name: Cargo Check
        run: |
          cargo check --all-features
          cargo check --tests --all-features

      - name: Output clippy to Github
        uses: actions-rs/clippy-check@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --all-targets

  test:
    name: Tests
    needs: build-test-artifacts
    runs-on: ziserv-2
    container:
      image: zingodevops/zaino-ci:latest  # Your pre-built Docker image
    strategy:
      fail-fast: false
      matrix:
        partition: 
          - "integration-tests::fetch_service"
          - "integration-tests::state_service"
          - "integration-tests::local_cache"
          - "integration-tests::wallet_to_validator"
          - "zaino-testutils"

    steps:

      - uses: actions/checkout@v4

      - run: rustup toolchain install stable --profile minimal

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with:
          cache-provider: buildjet

      - name: Copy bins into test_binaries
        run: |
          mkdir -p ./test_binaries/bins
          cp /usr/local/bin/* ./test_binaries/bins/

      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: nextest-archive

      - name: Run Tests (Nextest)
        # continue-on-error: true
        run: |
          cargo nextest run --verbose --profile ci --retries 2 --archive-file nextest-archive.tar.zst \
            --workspace-remap ./ --filterset "binary_id(${{ matrix.partition }})" ${{ env.NEXTEST-FLAGS }}

      - name: Test Summary
        uses: test-summary/action@v2
        with:
          paths: "target/nextest/ci/junit.xml"
        if: always()

  fmt:
    name: Rustfmt
    runs-on: ziserv-2
    steps:
      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-provider: buildjet

      - name: Check formatting
        run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ziserv-2
    steps:
      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-provider: buildjet

      - name: Run clippy with console output
        run: cargo clippy --all-targets
        continue-on-error: true

      - name: Output clippy to Github
        uses: actions-rs/clippy-check@v1
        # Remove when clippy is green in local dev environments
        continue-on-error: true
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          args: --all-targets

  whitespace:
    name: Whitespace check
    runs-on: ziserv-2
    steps:
      - uses: actions/checkout@v4

      - uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: Cargo cache
        uses: Swatinem/rust-cache@v2
        with: 
          cache-provider: buildjet

      - name: Check trailing whitespace
        run: ./utils/trailing-whitespace.sh reject
        working-directory: .

  docker:
    name: Build Docker images
    runs-on: ziserv-2
    env:
      PUSH_IMAGES: true
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata for Docker (default image)
        id: meta-default
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}
          tags: |
            type=semver,pattern={{version}}, prefix=v

      - name: Build and Push Default Image
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64
          push: ${{ env.PUSH_IMAGES }}
          tags: ${{ steps.meta-default.outputs.tags }}
          labels: ${{ steps.meta-default.outputs.labels }}
          cache-from: |
            type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}:buildcache
            type=gha
          cache-to: |
            type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}:buildcache,mode=max
            type=gha,mode=max


      - name: Extract metadata for Docker (no-tls image)
        id: meta-no-tls
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}
          flavor: |
            suffix=-no-tls
          tags: |
            type=semver,pattern={{version}}, prefix=v

      - name: Build and Push No-TLS Image
        uses: docker/build-push-action@v5
        with:
          build-args: NO_TLS=true
          context: .
          platforms: linux/amd64
          push: ${{ env.PUSH_IMAGES }}
          tags: "${{ steps.meta-no-tls.outputs.tags }}"
          labels: ${{ steps.meta-no-tls.outputs.labels }}
          cache-from: |
            type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}:buildcache-no-tls
            type=gha
          cache-to: |
            type=registry,ref=${{ secrets.DOCKERHUB_USERNAME }}/${{ vars.DOCKER_REPO || 'zaino' }}:buildcache-no-tls,mode=max
            type=gha,mode=max

  create-release:
    needs: docker
    name: Create GitHub Release
    runs-on: ziserv-2
    if: startsWith(github.ref, 'refs/tags/') && github.token != ''

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREVIOUS_TAG" ]; then
            git log --pretty=format:"* %s" > CHANGELOG.md
          else
            git log --pretty=format:"* %s" $PREVIOUS_TAG..HEAD > CHANGELOG.md
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            CHANGELOG.md
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
